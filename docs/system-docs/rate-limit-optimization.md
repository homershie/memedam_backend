# 迷因相關 API 速率限制優化

## 問題描述

原本的全域 API 速率限制過於嚴格，導致用戶在瀏覽迷因時經常被阻擋，影響用戶體驗。

## 解決方案

為迷因相關的 API 創建了更寬鬆的速率限制，同時保持敏感操作（如登入、註冊）的嚴格限制。

## 修改內容

### 1. 新增迷因 API 寬鬆限制 (`middleware/rateLimit.js`)

- **限制名稱**: `memeApiLimiter`
- **時間窗口**: 15 分鐘
- **限制次數**:
  - 已登入用戶: 10000 次/15分鐘
  - 未登入用戶: 2000 次/15分鐘

### 2. 臨時解決方案（2024年12月）

由於用戶仍然遇到 429 錯誤，暫時完全移除迷因相關 API 的速率限制：

- 所有迷因相關 API 目前無速率限制
- 保持敏感操作（登入、註冊、email）的嚴格限制
- 其他 API 使用標準限制
- **適用路徑**:
  - `/api/memes` - 迷因相關
  - `/api/likes` - 按讚功能
  - `/api/dislikes` - 倒讚功能
  - `/api/comments` - 評論功能
  - `/api/tags` - 標籤功能
  - `/api/meme-tags` - 迷因標籤
  - `/api/collections` - 收藏功能
  - `/api/views` - 瀏覽統計
  - `/api/shares` - 分享功能
  - `/api/notifications` - 通知功能
  - `/api/recommendations` - 推薦功能
  - `/api/analytics` - 分析功能

### 2. 修改全域 API 限制 (`middleware/rateLimit.js`)

- 在全域 `apiLimiter` 中添加 `skip` 函數
- 自動跳過迷因相關路徑，避免重複限制
- 保持其他 API 的原有限制

### 3. 調整中間件順序 (`index.js`)

- 優先應用迷因相關的寬鬆限制
- 然後應用全域 API 限制
- 最後應用特定路徑的嚴格限制

## 限制對比

| API 類型     | 已登入用戶 | 未登入用戶 | 時間窗口 |
| ------------ | ---------- | ---------- | -------- |
| 迷因相關 API | 無限制     | 無限制     | 無限制   |
| 一般 API     | 1000 次    | 200 次     | 15 分鐘  |
| 認證 API     | 30 次      | 30 次      | 10 分鐘  |
| 登入 API     | 5 次       | 5 次       | 15 分鐘  |
| 註冊 API     | 3 次       | 3 次       | 1 小時   |

## 效果

- 用戶可以更自由地瀏覽迷因、按讚、評論等
- 敏感操作仍然受到適當保護
- 提升了整體用戶體驗
- 減少了因速率限制導致的用戶流失

## 測試

創建了 `test/rate-limit-test.js` 來驗證速率限制的正確應用。

## 注意事項

- 修改後需要重啟伺服器才能生效
- 在生產環境中，建議監控 API 使用情況
- 如果發現濫用情況，可以進一步調整限制參數
