# å¾Œç«¯ä¼ºæœå™¨ä¿®å¾©å•é¡Œæ¸…å–®

## ðŸ“‹ å•é¡Œç¸½çµ

æ ¹æ“šå¾Œç«¯ä¼ºæœå™¨çµ‚ç«¯æ©Ÿæ—¥èªŒåˆ†æžï¼Œä»¥ä¸‹æ˜¯éœ€è¦ä¿®å¾©çš„ä¸»è¦å•é¡Œï¼š

### 1. æ•¸æ“šåº«æ•¸æ“šé¡žåž‹éŒ¯èª¤

**å•é¡Œæè¿°ï¼š**

- æ•¸æ“šåº«ä¸­æŸäº›è¿·å› çš„ `like_count` å­—æ®µè¢«éŒ¯èª¤è¨­ç½®ç‚ºæŸ¥è©¢æ¢ä»¶ç‰©ä»¶ `{ '$gte': 5 }` è€Œéžæ•¸å€¼
- å°Žè‡´ CastError: Cast to Number failed

**éŒ¯èª¤ä¿¡æ¯ï¼š**

```
CastError: Cast to Number failed for value "{ '$gte': 5 }" (type Object) at path "like_count" for model "Meme"
```

**å½±éŸ¿æ¨¡çµ„ï¼š**

- ç†±é–€å…§å®¹é€šçŸ¥ä»»å‹™ (`services/notificationScheduler.js`)
- ç†±é–€åˆ†æ•¸æ›´æ–° (`utils/hotScoreScheduler.js`)
- æŽ¨è–¦ç³»çµ±æŸ¥è©¢

### 2. ç†±é–€åˆ†æ•¸æ›´æ–°æ‰¹æ¬¡è™•ç†å¤±æ•—

**å•é¡Œæè¿°ï¼š**

- æ¯å°æ™‚ç†±é–€åˆ†æ•¸æ›´æ–°ä»»å‹™æŒçºŒå¤±æ•—
- æ‰¹æ¬¡è™•ç†é¡¯ç¤º "æˆåŠŸ 0 å€‹, å¤±æ•— 1 å€‹"

**å½±éŸ¿ï¼š**

- ç„¡æ³•æ­£å¸¸æ›´æ–°è¿·å› ç†±é–€åˆ†æ•¸
- å½±éŸ¿ç†±é–€æ¦œå–®æŽ’åºæº–ç¢ºæ€§

### 3. æ•¸æ“šå®Œæ•´æ€§å•é¡Œ

**å•é¡Œæè¿°ï¼š**

- æ•¸æ“šåº«ä¸­å¯èƒ½å­˜åœ¨å…¶ä»–å­—æ®µçš„é¡žåž‹éŒ¯èª¤
- å½±éŸ¿ comment_count, view_count, hot_score ç­‰è¨ˆæ•¸å­—æ®µ

## ðŸ”§ ä¿®å¾©è¨ˆåŠƒ

### éšŽæ®µä¸€ï¼šç·Šæ€¥ä¿®å¾©ï¼ˆå„ªå…ˆç´šï¼šé«˜ï¼‰

#### 1.1 ä¿®å¾© like_count æ•¸æ“šéŒ¯èª¤

**ä¿®å¾©æ–‡ä»¶ï¼š**

- `services/notificationScheduler.js` - getHotMemes å‡½æ•¸
- `utils/hotScoreScheduler.js` - batchUpdateHotScores å‡½æ•¸

**ä¿®å¾©å…§å®¹ï¼š**

- æª¢æŸ¥æ•¸æ“šåº«ä¸­æ‰€æœ‰ like_count çš„æ•¸æ“šé¡žåž‹
- å°‡éŒ¯èª¤çš„ç‰©ä»¶å€¼ä¿®å¾©ç‚ºæ­£ç¢ºçš„æ•¸å€¼
- åŸºæ–¼å¯¦éš› Like è¨˜éŒ„é‡æ–°è¨ˆç®— like_count

**ä¿®å¾©æ­¥é©Ÿï¼š**

1. å‰µå»ºæ•¸æ“šæª¢æŸ¥è…³æœ¬ `scripts/maintenance/fix-like-count-data.js`
2. æŸ¥è©¢æ‰€æœ‰ like_count ä¸æ˜¯æ•¸å€¼çš„è¨˜éŒ„
3. è¨ˆç®—å¯¦éš›çš„æŒ‰è®šæ•¸é‡
4. æ‰¹é‡æ›´æ–°éŒ¯èª¤çš„è¨˜éŒ„

#### 1.2 ä¿®å¾©ç†±é–€åˆ†æ•¸æ›´æ–°

**ä¿®å¾©æ–‡ä»¶ï¼š**

- `utils/hotScoreScheduler.js` - batchUpdateHotScores å‡½æ•¸

**ä¿®å¾©å…§å®¹ï¼š**

- æ·»åŠ æ›´å¥½çš„éŒ¯èª¤è™•ç†
- ä¿®å¾©æ‰¹æ¬¡è™•ç†é‚è¼¯
- å¢žåŠ æ•¸æ“šé©—è­‰

### éšŽæ®µäºŒï¼šæ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥ï¼ˆå„ªå…ˆç´šï¼šä¸­ï¼‰

#### 2.1 æª¢æŸ¥æ‰€æœ‰è¨ˆæ•¸å­—æ®µ

**æª¢æŸ¥å­—æ®µï¼š**

- like_count
- dislike_count
- comment_count
- view_count
- collection_count
- share_count
- hot_score

**ä¿®å¾©å…§å®¹ï¼š**

- æª¢æŸ¥æ¯ä¸€å€‹å­—æ®µçš„æ•¸æ“šé¡žåž‹
- ä¿®å¾©ç„¡æ•ˆçš„æ•¸æ“š
- å»ºç«‹æ•¸æ“šå®Œæ•´æ€§é©—è­‰è…³æœ¬

#### 2.2 å¢žå¼·æ•¸æ“šé©—è­‰

**ä¿®å¾©æ–‡ä»¶ï¼š**

- `models/Meme.js` - æ¨¡å¼å®šç¾©
- `controllers/likeController.js` - æŒ‰è®šæ“ä½œ
- `controllers/commentController.js` - è©•è«–æ“ä½œ
- `controllers/viewController.js` - ç€è¦½æ“ä½œ

**ä¿®å¾©å…§å®¹ï¼š**

- åœ¨æ•¸æ“šä¿å­˜å‰é€²è¡Œé¡žåž‹æª¢æŸ¥
- æ·»åŠ æ•¸æ“šé©—è­‰ä¸­é–“ä»¶
- é˜²æ­¢é¡žä¼¼éŒ¯èª¤å†æ¬¡ç™¼ç”Ÿ

### éšŽæ®µä¸‰ï¼šé é˜²æŽªæ–½ï¼ˆå„ªå…ˆç´šï¼šä½Žï¼‰

#### 3.1 å¢žåŠ éŒ¯èª¤ç›£æŽ§

**ä¿®å¾©æ–‡ä»¶ï¼š**

- `utils/logger.js` - æ—¥èªŒç³»çµ±
- `services/notificationScheduler.js` - é€šçŸ¥èª¿åº¦å™¨

**ä¿®å¾©å…§å®¹ï¼š**

- å¢žåŠ æ›´è©³ç´°çš„éŒ¯èª¤æ—¥èªŒ
- æ·»åŠ æ•¸æ“šç•°å¸¸è­¦å ±
- å»ºç«‹å¥åº·æª¢æŸ¥ç«¯é»ž

#### 3.2 å„ªåŒ–æŸ¥è©¢æ€§èƒ½

**ä¿®å¾©æ–‡ä»¶ï¼š**

- `services/recommendationScheduler.js` - æŽ¨è–¦ç³»çµ±
- `utils/hotScoreScheduler.js` - ç†±é–€åˆ†æ•¸æ›´æ–°

**ä¿®å¾©å…§å®¹ï¼š**

- å„ªåŒ–æ•¸æ“šåº«æŸ¥è©¢
- æ¸›å°‘ä¸å¿…è¦çš„æ•¸æ“šåº«æ“ä½œ
- å¢žåŠ å¿«å–æ©Ÿåˆ¶

## ðŸ“ å…·é«”ä¿®å¾©ä»»å‹™

### ä»»å‹™ 1ï¼šå‰µå»ºæ•¸æ“šä¿®å¾©è…³æœ¬

**ç‹€æ…‹ï¼š** â³ å¾…å®Œæˆ
**è² è²¬äººï¼š** é–‹ç™¼åœ˜éšŠ
**é ä¼°æ™‚é–“ï¼š** 2-3 å°æ™‚

**ä»»å‹™å…§å®¹ï¼š**

1. å‰µå»º `scripts/maintenance/fix-like-count-data.js`
2. å¯¦ç¾æ•¸æ“šæª¢æŸ¥é‚è¼¯
3. å¯¦ç¾æ•¸æ“šä¿®å¾©é‚è¼¯
4. æ·»åŠ è©³ç´°çš„æ—¥èªŒè¨˜éŒ„

**é©—è­‰æ–¹æ³•ï¼š**

- é‹è¡Œè…³æœ¬æª¢æŸ¥æ•¸æ“šå®Œæ•´æ€§
- ç¢ºèªä¿®å¾©å¾Œçš„æ•¸æ“šé¡žåž‹æ­£ç¢º
- æ¸¬è©¦ç†±é–€å…§å®¹é€šçŸ¥åŠŸèƒ½æ¢å¾©æ­£å¸¸

### ä»»å‹™ 2ï¼šä¿®å¾©é€šçŸ¥èª¿åº¦å™¨

**ç‹€æ…‹ï¼š** â³ å¾…å®Œæˆ
**è² è²¬äººï¼š** é–‹ç™¼åœ˜éšŠ
**é ä¼°æ™‚é–“ï¼š** 1-2 å°æ™‚

**ä»»å‹™å…§å®¹ï¼š**

1. ä¿®æ”¹ `services/notificationScheduler.js`
2. åœ¨ getHotMemes å‡½æ•¸ä¸­å¢žåŠ æ•¸æ“šé©—è­‰
3. æ·»åŠ éŒ¯èª¤è™•ç†å’Œæ¢å¾©æ©Ÿåˆ¶
4. å¢žåŠ é‡è©¦é‚è¼¯

**é©—è­‰æ–¹æ³•ï¼š**

- æ¸¬è©¦ç†±é–€å…§å®¹é€šçŸ¥ä»»å‹™æ­£å¸¸é‹è¡Œ
- ç¢ºèªé€šçŸ¥èƒ½å¤ æˆåŠŸç™¼é€
- æª¢æŸ¥æ—¥èªŒä¸­ä¸å†å‡ºç¾ CastError

### ä»»å‹™ 3ï¼šä¿®å¾©ç†±é–€åˆ†æ•¸æ›´æ–°

**ç‹€æ…‹ï¼š** â³ å¾…å®Œæˆ
**è² è²¬äººï¼š** é–‹ç™¼åœ˜éšŠ
**é ä¼°æ™‚é–“ï¼š** 1-2 å°æ™‚

**ä»»å‹™å…§å®¹ï¼š**

1. ä¿®æ”¹ `utils/hotScoreScheduler.js`
2. ä¿®å¾© batchUpdateHotScores å‡½æ•¸
3. å¢žåŠ æ›´å¥½çš„éŒ¯èª¤è™•ç†
4. æ·»åŠ æ•¸æ“šé©—è­‰

**é©—è­‰æ–¹æ³•ï¼š**

- æ¸¬è©¦æ¯å°æ™‚ç†±é–€åˆ†æ•¸æ›´æ–°æ­£å¸¸é‹è¡Œ
- ç¢ºèªæ‰¹æ¬¡è™•ç†æˆåŠŸå®Œæˆ
- æª¢æŸ¥ç†±é–€åˆ†æ•¸æ­£ç¢ºæ›´æ–°

### ä»»å‹™ 4ï¼šå¢žå¼·æ•¸æ“šé©—è­‰

**ç‹€æ…‹ï¼š** â³ å¾…å®Œæˆ
**è² è²¬äººï¼š** é–‹ç™¼åœ˜éšŠ
**é ä¼°æ™‚é–“ï¼š** 2-3 å°æ™‚

**ä»»å‹™å…§å®¹ï¼š**

1. ä¿®æ”¹ `models/Meme.js` æ¨¡å¼å®šç¾©
2. åœ¨æŽ§åˆ¶å™¨ä¸­å¢žåŠ æ•¸æ“šé©—è­‰
3. å‰µå»ºæ•¸æ“šé©—è­‰ä¸­é–“ä»¶
4. æ·»åŠ é¡žåž‹æª¢æŸ¥

**é©—è­‰æ–¹æ³•ï¼š**

- æ¸¬è©¦å„ç¨®æ•¸æ“šæ“ä½œä¸å†ç”¢ç”Ÿé¡žåž‹éŒ¯èª¤
- ç¢ºèªæ•¸æ“šä¿å­˜å‰é€²è¡Œæ­£ç¢ºé©—è­‰
- æª¢æŸ¥æ•¸æ“šåº«ä¸­çš„æ•¸æ“šå§‹çµ‚ä¿æŒæ­£ç¢ºé¡žåž‹

## ðŸŽ¯ é©—è­‰æ¨™æº–

### åŠŸèƒ½é©—è­‰

- [ ] ç†±é–€å…§å®¹é€šçŸ¥ä»»å‹™æ­£å¸¸é‹è¡Œ
- [ ] ç†±é–€åˆ†æ•¸æ›´æ–°æ‰¹æ¬¡è™•ç†æˆåŠŸ
- [ ] æ‰€æœ‰è¨ˆæ•¸å­—æ®µæ•¸æ“šé¡žåž‹æ­£ç¢º
- [ ] æŽ¨è–¦ç³»çµ±æŸ¥è©¢æ­£å¸¸å·¥ä½œ

### æ•¸æ“šé©—è­‰

- [ ] like_count å­—æ®µéƒ½æ˜¯æœ‰æ•ˆçš„æ•¸å€¼
- [ ] comment_count å­—æ®µéƒ½æ˜¯æœ‰æ•ˆçš„æ•¸å€¼
- [ ] view_count å­—æ®µéƒ½æ˜¯æœ‰æ•ˆçš„æ•¸å€¼
- [ ] hot_score å­—æ®µéƒ½æ˜¯æœ‰æ•ˆçš„æ•¸å€¼

### æ€§èƒ½é©—è­‰

- [ ] æ•¸æ“šåº«æŸ¥è©¢æ€§èƒ½ä¸å—å½±éŸ¿
- [ ] æ‰¹æ¬¡è™•ç†æ™‚é–“åœ¨åˆç†ç¯„åœå…§
- [ ] å…§å­˜ä½¿ç”¨æ­£å¸¸

## ðŸ“Š é¢¨éšªè©•ä¼°

### é«˜é¢¨éšªé …ç›®

1. **æ•¸æ“šä¿®å¾©è…³æœ¬**ï¼šå¯èƒ½å½±éŸ¿ç”Ÿç”¢æ•¸æ“šï¼Œéœ€è¦ä»”ç´°æ¸¬è©¦
2. **æ¨¡å¼å®šç¾©ä¿®æ”¹**ï¼šå¯èƒ½å½±éŸ¿ç¾æœ‰æ•¸æ“šçµæ§‹

### ä¸­é¢¨éšªé …ç›®

1. **æŸ¥è©¢æ¢ä»¶ä¿®æ”¹**ï¼šå¯èƒ½æ”¹è®ŠæŸ¥è©¢çµæžœ
2. **éŒ¯èª¤è™•ç†å¢žåŠ **ï¼šå¯èƒ½å½±éŸ¿ç¾æœ‰é‚è¼¯

### ä½Žé¢¨éšªé …ç›®

1. **æ—¥èªŒå¢žåŠ **ï¼šä¸æœƒå½±éŸ¿åŠŸèƒ½
2. **é©—è­‰å¢žåŠ **ï¼šæé«˜ç³»çµ±ç©©å®šæ€§

## ðŸ“ˆ æˆåŠŸæŒ‡æ¨™

- ç†±é–€å…§å®¹é€šçŸ¥ä»»å‹™æˆåŠŸçŽ‡ï¼š100%
- ç†±é–€åˆ†æ•¸æ›´æ–°æˆåŠŸçŽ‡ï¼š100%
- æ•¸æ“šé¡žåž‹éŒ¯èª¤ï¼š0 å€‹
- ç³»çµ±ç©©å®šé‹è¡Œæ™‚é–“ï¼š>99.9%

---

**æ–‡æª”ç‰ˆæœ¬ï¼š** v1.0
**å‰µå»ºæ—¥æœŸï¼š** 2025-09-10
**æ›´æ–°æ—¥æœŸï¼š** 2025-09-10
**è² è²¬äººï¼š** é–‹ç™¼åœ˜éšŠ
