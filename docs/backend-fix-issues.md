# 後端伺服器修復問題清單

## 📋 問題總結

根據後端伺服器終端機日誌分析，以下是需要修復的主要問題：

### 1. 數據庫數據類型錯誤

**問題描述：**

- 數據庫中某些迷因的 `like_count` 字段被錯誤設置為查詢條件物件 `{ '$gte': 5 }` 而非數值
- 導致 CastError: Cast to Number failed

**錯誤信息：**

```
CastError: Cast to Number failed for value "{ '$gte': 5 }" (type Object) at path "like_count" for model "Meme"
```

**影響模組：**

- 熱門內容通知任務 (`services/notificationScheduler.js`)
- 熱門分數更新 (`utils/hotScoreScheduler.js`)
- 推薦系統查詢

### 2. 熱門分數更新批次處理失敗

**問題描述：**

- 每小時熱門分數更新任務持續失敗
- 批次處理顯示 "成功 0 個, 失敗 1 個"

**影響：**

- 無法正常更新迷因熱門分數
- 影響熱門榜單排序準確性

### 3. 數據完整性問題

**問題描述：**

- 數據庫中可能存在其他字段的類型錯誤
- 影響 comment_count, view_count, hot_score 等計數字段

## 🔧 修復計劃

### 階段一：緊急修復（優先級：高）

#### 1.1 修復 like_count 數據錯誤

**修復文件：**

- `services/notificationScheduler.js` - getHotMemes 函數
- `utils/hotScoreScheduler.js` - batchUpdateHotScores 函數

**修復內容：**

- 檢查數據庫中所有 like_count 的數據類型
- 將錯誤的物件值修復為正確的數值
- 基於實際 Like 記錄重新計算 like_count

**修復步驟：**

1. 創建數據檢查腳本 `scripts/maintenance/fix-like-count-data.js`
2. 查詢所有 like_count 不是數值的記錄
3. 計算實際的按讚數量
4. 批量更新錯誤的記錄

#### 1.2 修復熱門分數更新

**修復文件：**

- `utils/hotScoreScheduler.js` - batchUpdateHotScores 函數

**修復內容：**

- 添加更好的錯誤處理
- 修復批次處理邏輯
- 增加數據驗證

### 階段二：數據完整性檢查（優先級：中）

#### 2.1 檢查所有計數字段

**檢查字段：**

- like_count
- dislike_count
- comment_count
- view_count
- collection_count
- share_count
- hot_score

**修復內容：**

- 檢查每一個字段的數據類型
- 修復無效的數據
- 建立數據完整性驗證腳本

#### 2.2 增強數據驗證

**修復文件：**

- `models/Meme.js` - 模式定義
- `controllers/likeController.js` - 按讚操作
- `controllers/commentController.js` - 評論操作
- `controllers/viewController.js` - 瀏覽操作

**修復內容：**

- 在數據保存前進行類型檢查
- 添加數據驗證中間件
- 防止類似錯誤再次發生

### 階段三：預防措施（優先級：低）

#### 3.1 增加錯誤監控

**修復文件：**

- `utils/logger.js` - 日誌系統
- `services/notificationScheduler.js` - 通知調度器

**修復內容：**

- 增加更詳細的錯誤日誌
- 添加數據異常警報
- 建立健康檢查端點

#### 3.2 優化查詢性能

**修復文件：**

- `services/recommendationScheduler.js` - 推薦系統
- `utils/hotScoreScheduler.js` - 熱門分數更新

**修復內容：**

- 優化數據庫查詢
- 減少不必要的數據庫操作
- 增加快取機制

## 📝 具體修復任務

### 任務 1：創建數據修復腳本

**狀態：** ⏳ 待完成
**負責人：** 開發團隊
**預估時間：** 2-3 小時

**任務內容：**

1. 創建 `scripts/maintenance/fix-like-count-data.js`
2. 實現數據檢查邏輯
3. 實現數據修復邏輯
4. 添加詳細的日誌記錄

**驗證方法：**

- 運行腳本檢查數據完整性
- 確認修復後的數據類型正確
- 測試熱門內容通知功能恢復正常

### 任務 2：修復通知調度器

**狀態：** ⏳ 待完成
**負責人：** 開發團隊
**預估時間：** 1-2 小時

**任務內容：**

1. 修改 `services/notificationScheduler.js`
2. 在 getHotMemes 函數中增加數據驗證
3. 添加錯誤處理和恢復機制
4. 增加重試邏輯

**驗證方法：**

- 測試熱門內容通知任務正常運行
- 確認通知能夠成功發送
- 檢查日誌中不再出現 CastError

### 任務 3：修復熱門分數更新

**狀態：** ⏳ 待完成
**負責人：** 開發團隊
**預估時間：** 1-2 小時

**任務內容：**

1. 修改 `utils/hotScoreScheduler.js`
2. 修復 batchUpdateHotScores 函數
3. 增加更好的錯誤處理
4. 添加數據驗證

**驗證方法：**

- 測試每小時熱門分數更新正常運行
- 確認批次處理成功完成
- 檢查熱門分數正確更新

### 任務 4：增強數據驗證

**狀態：** ⏳ 待完成
**負責人：** 開發團隊
**預估時間：** 2-3 小時

**任務內容：**

1. 修改 `models/Meme.js` 模式定義
2. 在控制器中增加數據驗證
3. 創建數據驗證中間件
4. 添加類型檢查

**驗證方法：**

- 測試各種數據操作不再產生類型錯誤
- 確認數據保存前進行正確驗證
- 檢查數據庫中的數據始終保持正確類型

## 🎯 驗證標準

### 功能驗證

- [ ] 熱門內容通知任務正常運行
- [ ] 熱門分數更新批次處理成功
- [ ] 所有計數字段數據類型正確
- [ ] 推薦系統查詢正常工作

### 數據驗證

- [ ] like_count 字段都是有效的數值
- [ ] comment_count 字段都是有效的數值
- [ ] view_count 字段都是有效的數值
- [ ] hot_score 字段都是有效的數值

### 性能驗證

- [ ] 數據庫查詢性能不受影響
- [ ] 批次處理時間在合理範圍內
- [ ] 內存使用正常

## 📊 風險評估

### 高風險項目

1. **數據修復腳本**：可能影響生產數據，需要仔細測試
2. **模式定義修改**：可能影響現有數據結構

### 中風險項目

1. **查詢條件修改**：可能改變查詢結果
2. **錯誤處理增加**：可能影響現有邏輯

### 低風險項目

1. **日誌增加**：不會影響功能
2. **驗證增加**：提高系統穩定性

## 📈 成功指標

- 熱門內容通知任務成功率：100%
- 熱門分數更新成功率：100%
- 數據類型錯誤：0 個
- 系統穩定運行時間：>99.9%

---

**文檔版本：** v1.0
**創建日期：** 2025-09-10
**更新日期：** 2025-09-10
**負責人：** 開發團隊
